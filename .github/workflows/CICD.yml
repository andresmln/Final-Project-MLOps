name: End-to-End MLOps Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  # GLOBAL VARIABLES
  MLFLOW_DIR: ${{ github.workspace }}/mlruns
  MLFLOW_TRACKING_URI: file://${{ github.workspace }}/mlruns
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/mlops_final_project:latest

jobs:
  # -----------------------------------------------------------
  # JOB 1: TRAIN & SERIALIZE (Optimized with uv)
  # -----------------------------------------------------------
  train:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1. Install uv (Very fast, single binary)
      - name: Install uv
        uses: astral-sh/setup-uv@v5

      # 2. Set up Python via uv
      - name: Set up Python
        run: uv python install 3.10

      # 3. Install Dependencies & Project
      - name: Install Dependencies
        run: uv sync

      # 4. Train Model
      - name: Train Model (Optuna + MLFlow)
        run: uv run python -m mylib.train

      # Save the trained model
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: model-artifacts
          path: |
            model.joblib
            scaler.joblib
            feature_names.joblib
            threshold.joblib
            metrics.json
            mlruns/

  # -----------------------------------------------------------
  # JOB 2: DEPLOY BACKEND TO RENDER
  # -----------------------------------------------------------
  deploy-backend-render:
    runs-on: ubuntu-latest
    needs: train
    steps:
      - uses: actions/checkout@v4

      # 1. Download the Trained Model from Job 1
      - name: Download Model Artifacts
        uses: actions/download-artifact@v4
        with:
          name: model-artifacts
          path: api/models_local 

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 2. Build & Push Image containing the NEW model
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: api/Dockerfile
          push: true
          tags: ${{ env.DOCKER_IMAGE }}

      # 3. Trigger Render to pull the new image
      - name: Trigger Render Deploy
        run: |
          # Uses the Deploy Hook from Render Settings
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_KEY }}"

  # -----------------------------------------------------------
  # JOB 3: DEPLOY FRONTEND TO HUGGING FACE (Automated Branch)
  # -----------------------------------------------------------
  deploy-frontend-hf:
    runs-on: ubuntu-latest
    needs: deploy-backend-render
    steps:
      - uses: actions/checkout@v4
      
      - name: Push GUI to Hugging Face
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
          HF_SPACE_NAME: ${{ secrets.HF_SPACE_NAME }}
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          # 1. Create a fresh temporary branch (orphan = no history)
          git checkout --orphan hf-space-deploy
          
          # 2. Remove everything except the 'gui' folder
          git reset
          
          # 3. Move 'gui' contents to root (SAFE COPY)
          # -r ensures subfolders (like images) are copied
          cp -r gui/* .
          
          # 4. Add EVERYTHING
          # This is safer than naming specific files. 
          # If you add 'logo.png' later, this script will catch it automatically.
          git add .
          
          # 5. Commit and Push to Hugging Face
          git commit -m "Deploy Frontend from GitHub Actions"
          
          # Add remote and push
          git remote add space https://$HF_USERNAME:$HF_TOKEN@huggingface.co/spaces/$HF_USERNAME/$HF_SPACE_NAME
          git push --force space hf-space-deploy:main