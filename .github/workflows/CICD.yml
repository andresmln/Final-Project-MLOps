name: End-to-End MLOps Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  # GLOBAL VARIABLES
  MLFLOW_DIR: ${{ github.workspace }}/mlruns
  MLFLOW_TRACKING_URI: file://${{ github.workspace }}/mlruns
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/mlops_final_project:latest

jobs:
  # ----------------------------------------------------------- 
  # JOB 0: CHECK WHICH FILES HAVE CHANGED
  # -----------------------------------------------------------
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      # Logic: Run if Manual Tag exists OR if specific files changed
      train: ${{ steps.check_flags.outputs.run_all == 'true' || steps.filter.outputs.train == 'true' }}
      backend: ${{ steps.check_flags.outputs.run_all == 'true' || steps.filter.outputs.backend == 'true' }}
      frontend: ${{ steps.check_flags.outputs.run_all == 'true' || steps.filter.outputs.frontend == 'true' }}
    steps:
    - uses: actions/checkout@v4
    
    # 1. Check commit message for "[all]"
    - name: Check for manual trigger flags
      id: check_flags
      run: |
        # Get the commit message safely
        MESSAGE="${{ github.event.head_commit.message }}"
        
        if [[ "$MESSAGE" == *"[all]"* ]]; then
          echo "‚úÖ Manual trigger '[all]' detected. Forcing all jobs to run."
          echo "run_all=true" >> $GITHUB_OUTPUT
        else
          echo "run_all=false" >> $GITHUB_OUTPUT
        fi
        
    # 2. Default filter logic
    - uses: dorny/paths-filter@v3
      id: filter
      with:
        filters: |
          train:
            - 'mylib/train.py'
            - 'mylib/train_shadow.py'
            - 'mylib/data_preprocess.py'
            - 'archive/**'
            - 'api/requirements.txt'
          backend:
            - 'api/**'
            - 'api/Dockerfile'
          frontend:
            - 'gui/**'

  # -----------------------------------------------------------
  # JOB 1: TRAIN & SERIALIZE
  # -----------------------------------------------------------
  train:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.train == 'true' || startsWith(github.ref, 'refs/tags/v') }}
    runs-on: ubuntu-latest
    
    # Define MLFLOW_DIR as a job-level env var
    env:
      MLFLOW_DIR: ${{ github.workspace }}/mlruns

    steps:
      - uses: actions/checkout@v4

      # 1. Install uv
      - name: Install uv
        uses: astral-sh/setup-uv@v5

      # 2. Set up Pythondef test_clean_data_structure(raw_data):

      - name: Set up Python
        run: uv python install 3.10

      # 3. Install Dependencies
      - name: Install Dependencies
        run: uv sync

      # 4. Run Unit Tests
      - name: Run Unit Tests
        run: uv run pytest tests/test_data_preprocess.py

      # 5. Train Models
      - name: Train Models (Optuna + MLFlow)
        env:
          MLFLOW_TRACKING_URI: ${{ env.MLFLOW_DIR }}
        run: uv run python -m mylib.train_pipeline

      # 6. Run Artifact Tests
      - name: Run Integration Tests
        run: uv run pytest tests/test_model_artifacts.py

      # 7. Save the trained model
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: model-artifacts
          if-no-files-found: error
          path: |
            api/models_local/model.joblib
            api/models_local/shadow_model.joblib
            api/models_local/scaler.joblib
            api/models_local/feature_names.joblib
            api/models_local/threshold.joblib
      
      # 8. CLEANUP
      - name: Remove MLFlow Directory
        if: always() # Run even if previous steps fail
        run: rm -rf ${{ env.MLFLOW_DIR }}
      

  # -----------------------------------------------------------
  # JOB 2: DEPLOY BACKEND TO RENDER
  # -----------------------------------------------------------
  deploy-backend-render:
    needs: [check-changes, train]
    if: |
      always() && 
      (needs.check-changes.outputs.backend == 'true' || needs.check-changes.outputs.train == 'true' || startsWith(github.ref, 'refs/tags/v'))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4


      # 1. If training was run, download the new model
      - name: Download NEW Model
        if: needs.train.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: model-artifacts
          path: .

      # 1 (alt)  If training was skipped, download the old model from history
      - name: Download OLD Model (Fallback)
        if: needs.train.result == 'skipped'
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: CICD.yml
          workflow_conclusion: success   # Must be from a green run
          name: model-artifacts
          path: .
          if_no_artifact_found: fail
          search_artifacts: true

      # 2. Normalize file paths (GitHub actions issue)
      # This script finds model.joblib wherever it is and moves it to api/models_local
      - name: Flatten Artifacts Structure
        run: |
          echo "üîç Searching for model.joblib..."
          FOUND_PATH=$(find . -name "model.joblib" -print -quit)
          
          if [ -z "$FOUND_PATH" ]; then
            echo "‚ùå ERROR: model.joblib not found!"
            find . -maxdepth 4 
            exit 1
          fi
          
          TARGET_PATH="./api/models_local/model.joblib"
          
          if [ "$FOUND_PATH" != "$TARGET_PATH" ]; then
            echo "‚ö†Ô∏è  Moving artifact from $FOUND_PATH to $TARGET_PATH..."
            mkdir -p api/models_local
            mv "$(dirname "$FOUND_PATH")"/* api/models_local/
            echo "‚úÖ Moved."
          else
            echo "‚úÖ Files are correct."
          fi
          ls -l api/models_local

      # 3. Setup environment for testing
      # We need Python & UV here now because we are running tests inside this job
      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python
        run: uv python install 3.10

      - name: Install Dependencies
        run: uv sync

      # 4. Run API tests
      # This runs before Docker Build. If this fails, we don't deploy.
      - name: Run API Integration Tests
        run: uv run pytest tests/test_api.py

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 5. Build & Push Image containing the NEW model
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: api/Dockerfile
          push: true
          tags: ${{ env.DOCKER_IMAGE }}

      # 6. Trigger Render to pull the new image
      - name: Trigger Render Deploy
        run: |
          # Uses the Deploy Hook from Render Settings
          curl -X POST "https://api.render.com/deploy/srv-d5bf210gjchc73c0b530?key=${{ secrets.RENDER_DEPLOY_HOOK_KEY }}"

  # -----------------------------------------------------------
  # JOB 3: DEPLOY FRONTEND TO HUGGING FACE (Automated Temporary Branch)
  # -----------------------------------------------------------
  deploy-frontend-hf:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.frontend == 'true' || startsWith(github.ref, 'refs/tags/v') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Push GUI to Hugging Face
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
          HF_SPACE_NAME: ${{ secrets.HF_SPACE_NAME }}
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          # 1. Switch to a fresh orphan branch
          git checkout --orphan hf-space-deploy
          
          # 2. Unstage all files (so they become "untracked")
          git reset
          
          # 3. Delete everything except the 'gui' folder and .git
          # -f: force, -d: directories, -x: ignored files, -e: exclude 'gui'
          git clean -fdx -e gui
          
          # 4. Move the contents of 'gui' to the root
          mv gui/* .
          #  Remove the now empty gui folder
          rm -rf gui
          
          # 5. 'git add .' adds the app files
          git add .
          
          git commit -m "Deploy Frontend from GitHub Actions"
          
          # Add remote and push
          git remote add space https://$HF_USERNAME:$HF_TOKEN@huggingface.co/spaces/$HF_USERNAME/$HF_SPACE_NAME
          git push --force space hf-space-deploy:main