name: End-to-End MLOps Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  # GLOBAL VARIABLES
  MLFLOW_DIR: ${{ github.workspace }}/mlruns
  MLFLOW_TRACKING_URI: file://${{ github.workspace }}/mlruns
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/mlops_final_project:latest

jobs:
  # ----------------------------------------------------------- 
  # JOB 0: CHECK WHICH FILES HAVE CHANGED
  # -----------------------------------------------------------
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      # We define two flags: 'train' and 'backend'
      train: ${{ steps.filter.outputs.train }}
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
    - uses: actions/checkout@v4
    - uses: dorny/paths-filter@v3
      id: filter
      with:
        filters: |
          train:
            - 'mylib/train.py'
            - 'mylib/train_shadow.py'
            - 'mylib/data_preprocess.py'
            - 'data/**'
            - 'api/requirements.txt'
          backend:
            - 'api/**'
            - 'api/Dockerfile'
          frontend:
            - 'gui/**'
  # -----------------------------------------------------------
  # JOB 1: TRAIN & SERIALIZE
  # -----------------------------------------------------------
  train:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.train == 'true' || startsWith(github.ref, 'refs/tags/v') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1. Install uv (Very fast, single binary)
      - name: Install uv
        uses: astral-sh/setup-uv@v5

      # 2. Set up Python via uv
      - name: Set up Python
        run: uv python install 3.10

      # 3. Install Dependencies & Project
      - name: Install Dependencies
        run: uv sync

      # 4. Run Unit Tests
      - name: Run Unit Tests
        run: |
          echo "ðŸ§ª Running Unit Tests..."
          pytest tests/test_data_preprocess.py

      # 5. Train Models
      - name: Train Models (Optuna + MLFlow)
        run: uv run python -m mylib.train_pipeline

      # 7. Run Integration Tests
      - name: Run Integration Tests
        run: |
          echo "ðŸ¤– Verifying Artifacts and API..."
          pytest tests/test_model_artifacts.py tests/test_api.py

      # 7. Save the trained model
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: model-artifacts
          path: |
            model.joblib
            shadow_model.joblib
            scaler.joblib
            feature_names.joblib
            threshold.joblib
            metrics.json
            mlruns/
      

  # -----------------------------------------------------------
  # JOB 2: DEPLOY BACKEND TO RENDER
  # -----------------------------------------------------------
  deploy-backend-render:
    needs: [check-changes, train]
    if: |
      always() && 
      (needs.check-changes.outputs.backend == 'true' || needs.check-changes.outputs.train == 'true' || startsWith(github.ref, 'refs/tags/v'))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4


      # 1. If training was run, download the new model
      - name: Download NEW Model
        if: needs.train.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: model-artifacts
          path: api/models_local 

      # 1 (alt)  If training was skipped, download the old model from history
      - name: Download OLD Model (Fallback)
        if: needs.train.result == 'skipped'
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: CICD.yml
          workflow_conclusion: success   # Must be from a green run
          name: model-artifacts
          path: api/models_local
          if_no_artifact_found: fail
          search_artifacts: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 2. Build & Push Image containing the NEW model
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: api/Dockerfile
          push: true
          tags: ${{ env.DOCKER_IMAGE }}

      # 3. Trigger Render to pull the new image
      - name: Trigger Render Deploy
        run: |
          # Uses the Deploy Hook from Render Settings
          curl -X POST "https://api.render.com/deploy/srv-d5bf210gjchc73c0b530?key=${{ secrets.RENDER_DEPLOY_HOOK_KEY }}"

  # -----------------------------------------------------------
  # JOB 3: DEPLOY FRONTEND TO HUGGING FACE (Automated Temporar Branch)
  # -----------------------------------------------------------
  deploy-frontend-hf:
    needs: check-changes
    if: ${{ needs.check-changes.outputs.frontend == 'true' || startsWith(github.ref, 'refs/tags/v') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Push GUI to Hugging Face
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
          HF_SPACE_NAME: ${{ secrets.HF_SPACE_NAME }}
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          # 1. Switch to a fresh orphan branch
          git checkout --orphan hf-space-deploy
          
          # 2. Unstage all files (so they become "untracked")
          git reset
          
          # 3. Delete everything except the 'gui' folder and .git
          # -f: force, -d: directories, -x: ignored files, -e: exclude 'gui'
          git clean -fdx -e gui
          
          # 4. Move the contents of 'gui' to the root
          mv gui/* .
          #  Remove the now empty gui folder
          rm -rf gui
          
          # 5. 'git add .' adds the app files
          git add .
          
          git commit -m "Deploy Frontend from GitHub Actions"
          
          # Add remote and push
          git remote add space https://$HF_USERNAME:$HF_TOKEN@huggingface.co/spaces/$HF_USERNAME/$HF_SPACE_NAME
          git push --force space hf-space-deploy:main