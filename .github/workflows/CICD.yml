name: End-to-End MLOps Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# Definimos variables globales para MLFlow como pide el PDF
env:
  MLFLOW_DIR: ${{ github.workspace }}/mlruns
  MLFLOW_TRACKING_URI: file://${{ github.workspace }}/mlruns

jobs:
  # -----------------------------------------------------------
  # 1. ETAPA DE ENTRENAMIENTO (Train & Serialize)
  # -----------------------------------------------------------
  train:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install wheel setuptools
          
          # 1. Mira si existe dentro de la carpeta api/
          if [ -f api/requirements.txt ]; then 
            sed -i '/pywin32/d' api/requirements.txt
            sed -i '/winshell/d' api/requirements.txt
            pip install -r api/requirements.txt
          
          # 2. O si existe en la ra√≠z (aqu√≠ entra tu elif)
          elif [ -f requirements.txt ]; then
            sed -i '/pywin32/d' requirements.txt
            sed -i '/winshell/d' requirements.txt
            pip install -r requirements.txt
          fi

          # 3. Instalaci√≥n de seguridad por si lo anterior falla
          pip install shap optuna xgboost mlflow scikit-learn pandas python-dotenv matplotlib joblib
          
      - name: Train Model & Optimize (Optuna + MLFlow)
          # Ejecuta el entrenamiento. MLFLOW_TRACKING_URI se lee del env global.
        run: python -m mylib.train

      # Guardamos los archivos generados para pasarlos a las siguientes etapas
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: model-artifacts
          path: |
            model.joblib
            scaler.joblib
            feature_names.joblib
            threshold.joblib
            metrics.json
            mlruns/

  # -----------------------------------------------------------
  # 2. ETAPA DE CONSTRUCCI√ìN Y DESPLIEGUE (Docker)
  # -----------------------------------------------------------
  build-and-deploy:
    runs-on: ubuntu-latest
    needs: train  # Espera a que termine el entrenamiento
    permissions:
      contents: read
      packages: write
    
    steps:
      - uses: actions/checkout@v4

      # DESCARGAMOS EL MODELO EN LA CARPETA ESPECIFICA PARA QUE DOCKER LO VEA 
      - name: Download Model Artifacts
        uses: actions/download-artifact@v4
        with:
          name: model-artifacts
          path: api/models_local 

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: api/Dockerfile
          push: true
          
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/mlops-final_project_churn-api:latest

      # Limpieza del directorio MLFlow (requisito acad√©mico com√∫n)
      - name: Clean MLFlow Directory
        run: rm -rf ${{ env.MLFLOW_DIR }}

  # -----------------------------------------------------------
  # 3. INTERFAZ GR√ÅFICA (Hugging Face Spaces)
  # -----------------------------------------------------------
  deploy-hf:
    runs-on: ubuntu-latest
    needs: build-and-deploy
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
      
      # Descargamos los modelos frescos para subirlos a HF
      - name: Download Model Artifacts for HF
        uses: actions/download-artifact@v4
        with:
          name: model-artifacts
          path: .
      
      - name: Push to Hugging Face
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
          HF_SPACE_NAME: ${{ secrets.HF_SPACE_NAME }}
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"

          # -------------------------------------------------------
          # 1. PREPARACI√ìN DE LA RAMA LIMPIA (Orphan Branch)
          # -------------------------------------------------------
          # Creamos una rama nueva sin historia para evitar subir archivos pesados antiguos (PDF, ZIP)
          git checkout --orphan deploy-branch
          git reset --hard  # Reseteamos para dejar el staging area vac√≠o

          # -------------------------------------------------------
          # 2. CONFIGURACI√ìN DEL SPACE (Docker y README)
          # -------------------------------------------------------
          
          # A) Mover Dockerfile a la ra√≠z (Requisito de HF Spaces)
          # Git reset borr√≥ los archivos del √≠ndice, pero siguen en el disco.
          # Tenemos que recuperarlos del checkout original o simplemente operar con lo que hay.
          # NOTA: Al hacer checkout --orphan y reset, los archivos siguen en el directorio de trabajo.
          
          if [ -f "api/Dockerfile" ]; then
            cp api/Dockerfile .
            echo "‚úÖ Dockerfile movido a la ra√≠z"
          else
            echo "‚ö†Ô∏è ADVERTENCIA: No se encontr√≥ api/Dockerfile"
          fi

          # B) Crear README.md con la metadata para Docker
          echo "---" > README.md
          echo "title: MLOps Telco Churn" >> README.md
          echo "emoji: üöÄ" >> README.md
          echo "colorFrom: blue" >> README.md
          echo "colorTo: indigo" >> README.md
          echo "sdk: docker" >> README.md
          echo "app_port: 7860" >> README.md
          echo "pinned: false" >> README.md
          echo "---" >> README.md

          # -------------------------------------------------------
          # 3. PREPARAR GIT Y LFS
          # -------------------------------------------------------
          git remote add space https://$HF_USERNAME:$HF_TOKEN@huggingface.co/spaces/$HF_USERNAME/$HF_SPACE_NAME
          
          git lfs install
          git lfs track "*.joblib"
          git add .gitattributes

          # -------------------------------------------------------
          # 4. A√ëADIR ARCHIVOS AL COMMIT
          # -------------------------------------------------------
          
          # A) Artefactos generados (descargados del paso anterior)
          git add -f model.joblib scaler.joblib feature_names.joblib threshold.joblib metrics.json

          # B) Archivos de Configuraci√≥n y Arranque
          git add README.md Dockerfile
          git add requirements.txt || true
          git add main.py || true
          git add Preprocessing.py || true
          
          # C) Carpetas de c√≥digo
          if [ -d "api" ]; then git add api/; fi
          if [ -d "mylib" ]; then git add mylib/; fi
          if [ -d "templates" ]; then git add templates/; fi
          if [ -d "cli" ]; then git add cli/; fi

          # -------------------------------------------------------
          # 5. ENVIAR A HUGGING FACE
          # -------------------------------------------------------
          git commit -m "Deploy from GitHub Actions (Docker + Metrics)"
          git push --force space deploy-branch:main